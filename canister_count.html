<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canister Count</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 100px);
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .map-container {
            flex: 1;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .form-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #34495e;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .stats h3 {
            color: #155724;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
        }

        .stat-label {
            color: #495057;
            font-weight: 500;
        }

        .stat-value {
            color: #28a745;
            font-weight: 700;
        }

        .filters-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .filters-section h3 {
            color: #1565c0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .filter-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 120px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.25rem;
            color: #1565c0;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #90caf9;
            border-radius: 6px;
            font-size: 0.8rem;
            background: white;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-filter {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .charts-section {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(156, 39, 176, 0.2);
        }

        .charts-section h3 {
            color: #7b1fa2;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            height: 200px;
            position: relative;
        }

        .chart-container:last-child {
            margin-bottom: 0;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a148c;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            border: 1px solid rgba(156, 39, 176, 0.1);
        }

        .analytics-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #7b1fa2;
            margin-bottom: 0.25rem;
        }

        .analytics-label {
            font-size: 0.8rem;
            color: #6a1b9a;
            font-weight: 500;
        }

        .area-analysis {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .area-analysis h3 {
            color: #0d47a1;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .analysis-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid #2196f3;
        }

        .analysis-title {
            font-weight: 600;
            color: #0d47a1;
            margin-bottom: 0.5rem;
        }

        .analysis-details {
            font-size: 0.9rem;
            color: #424242;
            line-height: 1.5;
        }

        .risk-level {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .risk-low { background: #c8e6c9; color: #2e7d32; }
        .risk-moderate { background: #fff3e0; color: #f57c00; }
        .risk-high { background: #ffcdd2; color: #c62828; }
        .risk-critical { background: #f8bbd9; color: #880e4f; }

        .recent-sightings {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .recent-sightings h3 {
            color: #856404;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sighting-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid #ffc107;
        }

        .sighting-item:last-child {
            margin-bottom: 0;
        }

        .sighting-location {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .sighting-details {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .sighting-time {
            font-size: 0.8rem;
            color: #adb5bd;
        }

        .danger-info {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .danger-info h3 {
            color: #721c24;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .health-sections {
            display: grid;
            gap: 1rem;
        }

        .health-section {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .health-section.emergency {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left-color: #b71c1c;
        }

        .health-section h4 {
            color: #721c24;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .health-section ul {
            color: #721c24;
            font-size: 0.85rem;
            line-height: 1.6;
            padding-left: 1.5rem;
            margin: 0;
        }

        .health-section li {
            margin-bottom: 0.5rem;
        }

        .health-section li strong {
            color: #b71c1c;
        }

        .health-section p {
            color: #b71c1c;
            font-weight: 600;
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(183, 28, 28, 0.1);
            border-radius: 6px;
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 0.5rem;
            border: 2px solid #e9ecef;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .map-controls h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .control-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .control-option:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .control-option input[type="radio"] {
            margin-right: 8px;
        }

        .control-option label {
            font-size: 0.8rem;
            color: #495057;
            cursor: pointer;
            margin: 0;
        }

        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.8);
            border: 2px solid rgba(110, 204, 57, 0.8);
        }

        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.8);
            border: 2px solid rgba(240, 194, 12, 0.8);
        }

        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.8);
            border: 2px solid rgba(241, 128, 23, 0.8);
        }

        .marker-cluster {
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
        }

        .marker-cluster div {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heatmap-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .map-container {
                height: 400px;
                order: 1;
            }

            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎈 Nitrous Oxide Canister Tracker - Complete Edition</h1>
        <p>Advanced community-driven monitoring system for nitrous oxide waste and usage hotspots</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="stats">
                <h3>📊 Statistics</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Sightings:</span>
                    <span class="stat-value" id="totalSightings">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Today:</span>
                    <span class="stat-value" id="todaySightings">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Week:</span>
                    <span class="stat-value" id="weekSightings">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Filtered:</span>
                    <span class="stat-value" id="filteredSightings">0</span>
                </div>
            </div>

            <div class="filters-section">
                <h3>🔍 Advanced Filters</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="dateFrom">From Date:</label>
                        <input type="date" id="dateFrom">
                    </div>
                    <div class="filter-group">
                        <label for="dateTo">To Date:</label>
                        <input type="date" id="dateTo">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterCount">Canister Count:</label>
                        <select id="filterCount">
                            <option value="">All counts</option>
                            <option value="1-5">1-5 canisters</option>
                            <option value="6-10">6-10 canisters</option>
                            <option value="11-20">11-20 canisters</option>
                            <option value="20+">20+ canisters</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterCondition">Condition:</label>
                        <select id="filterCondition">
                            <option value="">All conditions</option>
                            <option value="scattered">Scattered on ground</option>
                            <option value="dumped">Dumped in pile</option>
                            <option value="binned">Near bins/disposal</option>
                            <option value="vehicle">Near vehicle</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-small btn-filter" id="applyFilters">Apply Filters</button>
                    <button class="btn-small btn-clear" id="clearFilters">Clear All</button>
                    <button class="btn-small" id="generateData" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white;">Generate Test Data</button>
                </div>
            </div>

            <div class="charts-section">
                <h3>📈 Data Analytics</h3>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-number" id="avgCanisters">0</div>
                        <div class="analytics-label">Avg Canisters</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" id="hotspotCount">0</div>
                        <div class="analytics-label">Hotspots</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Sightings Over Time</div>
                    <canvas id="timeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Condition Breakdown</div>
                    <canvas id="conditionChart"></canvas>
                </div>
            </div>

            <div class="form-section">
                <h3>📍 Report Sighting</h3>
                <form id="sightingForm">
                    <div class="form-group">
                        <label for="location">Location (click map to set):</label>
                        <input type="text" id="location" placeholder="Address or coordinates" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="canisterCount">Number of Canisters:</label>
                        <select id="canisterCount">
                            <option value="1-5">1-5 canisters</option>
                            <option value="6-10">6-10 canisters</option>
                            <option value="11-20">11-20 canisters</option>
                            <option value="20+">20+ canisters</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="condition">Condition:</label>
                        <select id="condition">
                            <option value="scattered">Scattered on ground</option>
                            <option value="dumped">Dumped in pile</option>
                            <option value="binned">Near bins/disposal</option>
                            <option value="vehicle">Near vehicle</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Additional Notes:</label>
                        <textarea id="notes" placeholder="Any additional observations..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="photo">Photo (optional):</label>
                        <input type="file" id="photo" accept="image/*" capture="environment">
                        <img id="photoPreview" class="image-preview" style="display: none;">
                    </div>

                    <button type="submit" class="btn" id="submitBtn">📝 Submit Sighting</button>
                </form>
            </div>

            <div class="area-analysis" id="areaAnalysis" style="display: none;">
                <h3>📍 Area Analysis</h3>
                <div id="analysisContent">
                    <!-- Analysis content will be inserted here -->
                </div>
            </div>

            <div class="recent-sightings">
                <h3>🕐 Recent Sightings</h3>
                <div id="recentSightingsList">
                    <p style="color: #6c757d; font-style: italic;">No sightings yet. Click on the map to add one!</p>
                </div>
            </div>

            <div class="danger-info">
                <h3>⚠️ Health Risks & Safety Information</h3>
                <div class="health-sections">
                    <div class="health-section">
                        <h4>🫁 Immediate Physical Risks</h4>
                        <ul>
                            <li><strong>Oxygen Deprivation:</strong> Can cause unconsciousness within seconds, leading to falls and serious injury</li>
                            <li><strong>Asphyxiation:</strong> Risk of suffocation, especially in enclosed spaces or with repeated use</li>
                            <li><strong>Cold Burns:</strong> Direct contact with gas can cause frostbite (-40°C temperature)</li>
                            <li><strong>Accidents:</strong> Loss of motor control increases fall and collision risks</li>
                        </ul>
                    </div>
                    
                    <div class="health-section">
                        <h4>🧠 Neurological Effects</h4>
                        <ul>
                            <li><strong>Vitamin B12 Depletion:</strong> Regular use blocks B12 absorption, causing nerve damage</li>
                            <li><strong>Memory Problems:</strong> Can affect short and long-term memory formation</li>
                            <li><strong>Coordination Issues:</strong> Impaired balance and motor skills</li>
                            <li><strong>Peripheral Neuropathy:</strong> Numbness and weakness in hands and feet</li>
                        </ul>
                    </div>
                    
                    <div class="health-section">
                        <h4>⚕️ Long-term Health Consequences</h4>
                        <ul>
                            <li><strong>Psychological Dependence:</strong> Risk of developing compulsive use patterns</li>
                            <li><strong>Anemia:</strong> B12 deficiency leads to reduced red blood cell production</li>
                            <li><strong>Spinal Cord Damage:</strong> Severe B12 deficiency can cause irreversible nerve damage</li>
                            <li><strong>Mental Health:</strong> Links to depression and anxiety disorders</li>
                        </ul>
                    </div>
                    
                    <div class="health-section emergency">
                        <h4>🚨 Emergency Signs</h4>
                        <ul>
                            <li>Unconsciousness or unresponsiveness</li>
                            <li>Difficulty breathing or blue lips/fingernails</li>
                            <li>Severe confusion or disorientation</li>
                            <li>Persistent numbness in limbs</li>
                        </ul>
                        <p><strong>If you witness these symptoms, call emergency services immediately (999 in UK)</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <h4>🗺️ View Mode</h4>
                <div class="control-option">
                    <input type="radio" id="markerView" name="mapView" value="markers" checked>
                    <label for="markerView">Markers</label>
                </div>
                <div class="control-option">
                    <input type="radio" id="heatmapView" name="mapView" value="heatmap">
                    <label for="heatmapView">Heatmap</label>
                </div>
                <div class="control-option">
                    <input type="radio" id="clusterView" name="mapView" value="clusters">
                    <label for="clusterView">Clusters</label>
                </div>
            </div>
            <div class="heatmap-legend">
                <strong>Hotspot Intensity:</strong><br>
                🟢 Low (1-2 sightings)<br>
                🟡 Moderate (3-5 sightings)<br>
                🔴 High (6+ sightings)
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        class NitrousTracker {
            constructor() {
                this.sightings = [];
                this.filteredSightings = [];
                this.map = null;
                this.selectedLatLng = null;
                this.markers = [];
                this.markerClusterGroup = null;
                this.heatmapLayer = null;
                this.currentView = 'markers';
                this.charts = {};
                this.filters = {
                    dateFrom: null,
                    dateTo: null,
                    canisterCount: '',
                    condition: ''
                };
                
                // Make this instance globally accessible for popup buttons
                window.currentTracker = this;
                
                this.initMap();
                this.initEventListeners();
                this.loadSightings();
                this.generateTestData();
                this.updateStats();
                this.initCharts();
            }

            initMap() {
                // Initialize map centered on London
                this.map = L.map('map').setView([51.5074, -0.1278], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(this.map);

                // Initialize marker cluster group
                this.markerClusterGroup = L.markerClusterGroup({
                    iconCreateFunction: (cluster) => {
                        const count = cluster.getChildCount();
                        let className = 'marker-cluster-small';
                        
                        if (count >= 20) className = 'marker-cluster-large';
                        else if (count >= 10) className = 'marker-cluster-medium';
                        
                        return new L.DivIcon({
                            html: `<div><span>${count}</span></div>`,
                            className: `marker-cluster ${className}`,
                            iconSize: new L.Point(40, 40)
                        });
                    },
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true
                });

                // Add click event to map
                this.map.on('click', (e) => {
                    this.selectLocation(e.latlng);
                });
            }

            initEventListeners() {
                document.getElementById('sightingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitSighting();
                });

                document.getElementById('photo').addEventListener('change', (e) => {
                    this.previewPhoto(e.target.files[0]);
                });

                // Map view controls
                document.querySelectorAll('input[name="mapView"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.changeMapView(e.target.value);
                    });
                });

                // Filter controls
                document.getElementById('applyFilters').addEventListener('click', () => {
                    this.applyFilters();
                });

                document.getElementById('clearFilters').addEventListener('click', () => {
                    this.clearFilters();
                });

                document.getElementById('generateData').addEventListener('click', () => {
                    this.generateTestData();
                    this.updateStats();
                    this.updateCharts();
                });
            }

            selectLocation(latlng) {
                this.selectedLatLng = latlng;
                
                // Update location input
                const locationInput = document.getElementById('location');
                locationInput.value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                
                // Add temporary marker
                if (this.tempMarker) {
                    this.map.removeLayer(this.tempMarker);
                }
                
                this.tempMarker = L.marker([latlng.lat, latlng.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(this.map);
            }

            previewPhoto(file) {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('photoPreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            submitSighting() {
                if (!this.selectedLatLng) {
                    alert('Please click on the map to select a location first!');
                    return;
                }

                const formData = new FormData(document.getElementById('sightingForm'));
                const photoFile = document.getElementById('photo').files[0];
                let photoData = null;

                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoData = e.target.result;
                        this.saveSighting(formData, photoData);
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    this.saveSighting(formData, photoData);
                }
            }

            saveSighting(formData, photoData) {
                const sighting = {
                    id: Date.now(),
                    lat: this.selectedLatLng.lat,
                    lng: this.selectedLatLng.lng,
                    location: document.getElementById('location').value,
                    canisterCount: document.getElementById('canisterCount').value,
                    condition: document.getElementById('condition').value,
                    notes: document.getElementById('notes').value,
                    photo: photoData,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString()
                };

                this.sightings.push(sighting);
                this.filteredSightings = [...this.sightings];
                this.saveSightings();
                this.addMarker(sighting);
                this.updateStats();
                this.updateRecentSightings();
                this.resetForm();
                this.updateMapVisualization();
                this.updateCharts();

                // Show success message
                const btn = document.getElementById('submitBtn');
                const originalText = btn.textContent;
                btn.textContent = '✅ Sighting Added!';
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }

            addMarker(sighting) {
                const intensity = this.getSightingIntensity(sighting.lat, sighting.lng);
                let iconColor = 'green';
                
                if (intensity >= 6) iconColor = 'red';
                else if (intensity >= 3) iconColor = 'orange';

                const marker = L.marker([sighting.lat, sighting.lng], {
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                });

                // Create enhanced popup content with both inline analysis and sidebar analysis
                const basicPopupContent = `
                    <div style="min-width: 200px; max-width: 280px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="margin: 0; font-size: 0.9rem;">🎈 N2O Sighting</h4>
                            <button onclick="window.currentTracker.showDetailedAnalysis(${sighting.lat}, ${sighting.lng}, this)" 
                                    style="background: #007bff; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">
                                📊
                            </button>
                        </div>
                        <div style="font-size: 0.8rem; line-height: 1.3;">
                            <p style="margin: 3px 0;"><strong>Canisters:</strong> ${sighting.canisterCount}</p>
                            <p style="margin: 3px 0;"><strong>Condition:</strong> ${sighting.condition}</p>
                            <p style="margin: 3px 0;"><strong>Date:</strong> ${sighting.date}</p>
                            ${sighting.notes ? `<p style="margin: 3px 0;"><strong>Notes:</strong> ${sighting.notes.substring(0, 40)}${sighting.notes.length > 40 ? '...' : ''}</p>` : ''}
                            ${sighting.photo ? `<img src="${sighting.photo}" style="width: 100%; max-width: 120px; height: auto; margin-top: 5px; border-radius: 3px;">` : ''}
                            <p style="font-size: 0.7rem; color: #666; margin: 5px 0 0 0;">Area: ${intensity} sighting(s)</p>
                        </div>
                        <div id="analysisContainer-${sighting.id}"></div>
                    </div>
                `;

                marker.bindPopup(basicPopupContent, {
                    maxWidth: 300,
                    maxHeight: 400
                });
                
                // Add click event to show area analysis in sidebar
                marker.on('click', () => {
                    this.showAreaAnalysis(sighting.lat, sighting.lng);
                });
                
                this.markers.push(marker);
                
                // Add to appropriate layer based on current view
                if (this.currentView === 'clusters') {
                    this.markerClusterGroup.addLayer(marker);
                } else if (this.currentView === 'markers') {
                    marker.addTo(this.map);
                }
            }

            showDetailedAnalysis(lat, lng, buttonElement) {
                // Find nearby sightings within 1km radius
                const radius = 0.01;
                const nearbySightings = this.sightings.filter(s => 
                    Math.abs(s.lat - lat) < radius && Math.abs(s.lng - lng) < radius
                );
                
                if (nearbySightings.length === 0) return;
                
                // Find the analysis container in the popup
                const popup = buttonElement.closest('.leaflet-popup-content');
                const sightingId = nearbySightings.find(s => 
                    Math.abs(s.lat - lat) < 0.0001 && Math.abs(s.lng - lng) < 0.0001
                )?.id || 'analysis';
                
                let analysisContainer = popup.querySelector(`#analysisContainer-${sightingId}`);
                if (!analysisContainer) {
                    analysisContainer = popup.querySelector('[id^="analysisContainer-"]');
                }
                
                if (!analysisContainer) return;
                
                // Toggle analysis visibility
                if (analysisContainer.innerHTML.trim() !== '') {
                    analysisContainer.innerHTML = '';
                    buttonElement.textContent = '📊';
                    return;
                }
                
                // Calculate statistics
                const totalCanisters = this.calculateTotalCanisters(nearbySightings);
                const conditionAnalysis = this.getConditionAnalysis(nearbySightings);
                const riskLevel = this.calculateRiskLevel(nearbySightings, totalCanisters);
                
                buttonElement.textContent = '❌';
                
                // Concise analysis content
                const recommendations = this.getCompactRecommendations(riskLevel.level, conditionAnalysis.primary);
                
                analysisContainer.innerHTML = `
                    <div style="border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px; font-size: 0.75rem;">
                        <div style="background: ${this.getRiskBgColor(riskLevel.level)}; padding: 6px; border-radius: 4px; margin-bottom: 6px;">
                            <div style="font-weight: 600; color: ${this.getRiskTextColor(riskLevel.level)}; font-size: 0.8rem;">${riskLevel.label}</div>
                            <div style="color: #444; line-height: 1.2; margin-top: 2px;">
                                ${nearbySightings.length} reports • ${totalCanisters.min}-${totalCanisters.max} canisters
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 6px;">
                            <strong style="color: #333;">Pattern:</strong> ${conditionAnalysis.primary} (${this.getTrendIcon(nearbySightings)})
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 5px; border-radius: 3px; color: #555;">
                            <strong>Action:</strong> ${recommendations}
                        </div>
                    </div>
                `;
            }

            showAreaAnalysis(lat, lng) {
                const analysisSection = document.getElementById('areaAnalysis');
                const analysisContent = document.getElementById('analysisContent');
                
                // Find nearby sightings within 1km radius
                const radius = 0.01;
                const nearbySightings = this.sightings.filter(s => 
                    Math.abs(s.lat - lat) < radius && Math.abs(s.lng - lng) < radius
                );
                
                if (nearbySightings.length === 0) {
                    analysisSection.style.display = 'none';
                    return;
                }
                
                // Calculate statistics
                const totalCanisters = this.calculateTotalCanisters(nearbySightings);
                const timespan = this.getTimespanAnalysis(nearbySightings);
                const conditionAnalysis = this.getConditionAnalysis(nearbySightings);
                const riskLevel = this.calculateRiskLevel(nearbySightings, totalCanisters);
                
                // Generate area name (simplified - in real app would use reverse geocoding)
                const areaName = `Location ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                
                analysisContent.innerHTML = `
                    <div class="analysis-item">
                        <div class="analysis-title">📍 ${areaName}</div>
                        <div class="analysis-details">
                            <strong>Total Sightings:</strong> ${nearbySightings.length} report(s)<br>
                            <strong>Estimated Canisters:</strong> ${totalCanisters.min}-${totalCanisters.max} units<br>
                            <strong>Time Period:</strong> ${timespan}
                        </div>
                        <span class="risk-level risk-${riskLevel.level}">${riskLevel.label}</span>
                    </div>
                    
                    <div class="analysis-item">
                        <div class="analysis-title">🔍 Usage Pattern Analysis</div>
                        <div class="analysis-details">
                            ${conditionAnalysis.description}<br><br>
                            <strong>Most Common Condition:</strong> ${conditionAnalysis.primary}<br>
                            <strong>Trend:</strong> ${this.getTrendAnalysis(nearbySightings)}
                        </div>
                    </div>
                    
                    <div class="analysis-item">
                        <div class="analysis-title">🎯 Location Insights</div>
                        <div class="analysis-details">
                            ${this.getLocationInsights(nearbySightings, riskLevel.level)}
                        </div>
                    </div>
                    
                    <div class="analysis-item">
                        <div class="analysis-title">💡 Recommendations</div>
                        <div class="analysis-details">
                            ${this.getRecommendations(riskLevel.level, conditionAnalysis.primary)}
                        </div>
                    </div>
                `;
                
                analysisSection.style.display = 'block';
                analysisSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Helper methods for analysis
            getRiskBgColor(level) {
                const colors = {
                    'low': '#d4edda',
                    'moderate': '#fff3cd', 
                    'high': '#f8d7da',
                    'critical': '#f5c6cb'
                };
                return colors[level] || colors.low;
            }
            
            getRiskTextColor(level) {
                const colors = {
                    'low': '#155724',
                    'moderate': '#856404',
                    'high': '#721c24', 
                    'critical': '#721c24'
                };
                return colors[level] || colors.low;
            }
            
            getTrendIcon(sightings) {
                if (sightings.length < 2) return '📊';
                
                const sortedSightings = sightings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const recentHalf = sortedSightings.slice(Math.ceil(sortedSightings.length / 2));
                const olderHalf = sortedSightings.slice(0, Math.floor(sortedSightings.length / 2));
                
                if (recentHalf.length > olderHalf.length) return '📈';
                if (recentHalf.length < olderHalf.length) return '📉';
                return '➡️';
            }
            
            getCompactRecommendations(riskLevel, primaryCondition) {
                if (riskLevel === 'critical') return 'Report to authorities immediately';
                if (riskLevel === 'high') return 'Community intervention needed';
                if (riskLevel === 'moderate') return 'Continue monitoring closely';
                return 'Standard monitoring sufficient';
            }
            
            calculateTotalCanisters(sightings) {
                let minTotal = 0, maxTotal = 0;
                
                sightings.forEach(s => {
                    switch(s.canisterCount) {
                        case '1-5':
                            minTotal += 1; maxTotal += 5;
                            break;
                        case '6-10':
                            minTotal += 6; maxTotal += 10;
                            break;
                        case '11-20':
                            minTotal += 11; maxTotal += 20;
                            break;
                        case '20+':
                            minTotal += 20; maxTotal += 50; // Estimate upper bound
                            break;
                    }
                });
                
                return { min: minTotal, max: maxTotal };
            }
            
            getTimespanAnalysis(sightings) {
                if (sightings.length === 1) return 'Single report';
                
                const dates = sightings.map(s => new Date(s.timestamp)).sort();
                const firstDate = dates[0];
                const lastDate = dates[dates.length - 1];
                const daysDiff = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 0) return 'Same day activity';
                if (daysDiff === 1) return 'Activity over 2 days';
                if (daysDiff <= 7) return `Activity over ${daysDiff} days`;
                if (daysDiff <= 30) return `Activity over ${Math.ceil(daysDiff/7)} weeks`;
                return `Activity over ${Math.ceil(daysDiff/30)} months`;
            }
            
            getConditionAnalysis(sightings) {
                const conditions = {};
                sightings.forEach(s => {
                    conditions[s.condition] = (conditions[s.condition] || 0) + 1;
                });
                
                const sortedConditions = Object.entries(conditions).sort((a, b) => b[1] - a[1]);
                const primary = sortedConditions[0][0];
                
                const descriptions = {
                    'scattered': 'Evidence suggests casual recreational use with canisters discarded randomly.',
                    'dumped': 'Large quantities dumped together indicate potential dealing or heavy group usage.',
                    'binned': 'Users showing some disposal awareness, but still indicating regular usage.',
                    'vehicle': 'Vehicle-associated usage suggests mobile consumption or potential supply activity.'
                };
                
                return {
                    primary: primary.charAt(0).toUpperCase() + primary.slice(1),
                    description: descriptions[primary] || 'Mixed usage patterns observed.'
                };
            }
            
            calculateRiskLevel(sightings, totalCanisters) {
                const count = sightings.length;
                const maxCanisters = totalCanisters.max;
                const recentActivity = sightings.filter(s => 
                    (Date.now() - new Date(s.timestamp)) < (7 * 24 * 60 * 60 * 1000)
                ).length;
                
                if (count >= 10 || maxCanisters >= 100 || recentActivity >= 5) {
                    return { level: 'critical', label: 'Critical Hotspot' };
                } else if (count >= 5 || maxCanisters >= 50 || recentActivity >= 3) {
                    return { level: 'high', label: 'High Activity Zone' };
                } else if (count >= 3 || maxCanisters >= 20 || recentActivity >= 2) {
                    return { level: 'moderate', label: 'Moderate Concern' };
                } else {
                    return { level: 'low', label: 'Low Activity' };
                }
            }
            
            getTrendAnalysis(sightings) {
                if (sightings.length < 2) return 'Insufficient data for trend analysis';
                
                const sortedSightings = sightings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const recentHalf = sortedSightings.slice(Math.ceil(sortedSightings.length / 2));
                const olderHalf = sortedSightings.slice(0, Math.floor(sortedSightings.length / 2));
                
                if (recentHalf.length > olderHalf.length) {
                    return '📈 Increasing activity (more recent reports)';
                } else if (recentHalf.length < olderHalf.length) {
                    return '📉 Decreasing activity (fewer recent reports)';
                } else {
                    return '➡️ Stable activity pattern';
                }
            }
            
            getLocationInsights(sightings, riskLevel) {
                const insights = [];
                
                if (riskLevel === 'critical') {
                    insights.push('⚠️ This area shows critical levels of nitrous oxide activity.');
                    insights.push('🏢 May indicate proximity to suppliers or popular usage venues.');
                } else if (riskLevel === 'high') {
                    insights.push('🔍 Elevated activity suggests regular usage in this location.');
                    insights.push('📍 Could be near nightlife, festivals, or gathering spots.');
                } else if (riskLevel === 'moderate') {
                    insights.push('👀 Moderate activity indicating occasional usage.');
                } else {
                    insights.push('✅ Lower activity levels in this area.');
                }
                
                const timeOfDay = this.analyzeTimePatterns(sightings);
                if (timeOfDay) insights.push(timeOfDay);
                
                return insights.join('<br>');
            }
            
            analyzeTimePatterns(sightings) {
                // Simplified time analysis - in real app would analyze actual reporting times
                const hasNotes = sightings.some(s => s.notes && s.notes.toLowerCase().includes('night'));
                if (hasNotes) return '🌙 Some reports suggest nighttime activity.';
                
                const recent = sightings.filter(s => (Date.now() - new Date(s.timestamp)) < (24 * 60 * 60 * 1000));
                if (recent.length > 0) return '⏰ Recent activity (within 24 hours).';
                
                return null;
            }
            
            getRecommendations(riskLevel, primaryCondition) {
                const recommendations = [];
                
                if (riskLevel === 'critical') {
                    recommendations.push('🚨 Consider reporting to local authorities or council');
                    recommendations.push('🏥 Increase awareness of nearby health services');
                    recommendations.push('🗑️ Request additional waste disposal facilities');
                } else if (riskLevel === 'high') {
                    recommendations.push('📢 Community awareness campaign recommended');
                    recommendations.push('🗑️ Additional disposal bins may help');
                } else if (riskLevel === 'moderate') {
                    recommendations.push('👁️ Continue monitoring this location');
                    recommendations.push('📚 Educational materials could be beneficial');
                } else {
                    recommendations.push('✅ Maintain current monitoring level');
                }
                
                if (primaryCondition === 'Vehicle') {
                    recommendations.push('🚗 Monitor for potential supply chain activity');
                }
                
                return recommendations.join('<br>');
            }

            // Map visualization methods
            changeMapView(viewType) {
                this.currentView = viewType;
                this.clearMapLayers();
                this.updateMapVisualization();
            }

            clearMapLayers() {
                // Remove all markers from map
                this.markers.forEach(marker => {
                    this.map.removeLayer(marker);
                });
                
                // Clear cluster group
                if (this.markerClusterGroup) {
                    this.markerClusterGroup.clearLayers();
                    this.map.removeLayer(this.markerClusterGroup);
                }
                
                // Remove heatmap layer
                if (this.heatmapLayer) {
                    this.map.removeLayer(this.heatmapLayer);
                }
            }

            updateMapVisualization() {
                this.clearMapLayers();
                
                if (this.currentView === 'markers') {
                    this.showMarkers();
                } else if (this.currentView === 'clusters') {
                    this.showClusters();
                } else if (this.currentView === 'heatmap') {
                    this.showHeatmap();
                }
            }

            showMarkers() {
                this.markers.forEach(marker => {
                    marker.addTo(this.map);
                });
            }

            showClusters() {
                if (this.markerClusterGroup) {
                    this.markers.forEach(marker => {
                        this.markerClusterGroup.addLayer(marker);
                    });
                    this.map.addLayer(this.markerClusterGroup);
                }
            }

            showHeatmap() {
                const dataToUse = this.filteredSightings.length > 0 ? this.filteredSightings : this.sightings;
                if (dataToUse.length > 0) {
                    const heatmapData = dataToUse.map(sighting => {
                        // Weight based on canister count
                        let weight = 1;
                        if (sighting.canisterCount === '6-10') weight = 2;
                        else if (sighting.canisterCount === '11-20') weight = 3;
                        else if (sighting.canisterCount === '20+') weight = 4;
                        
                        return [sighting.lat, sighting.lng, weight];
                    });

                    this.heatmapLayer = L.heatLayer(heatmapData, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 17,
                        max: 4,
                        gradient: {
                            0.2: 'blue',
                            0.4: 'cyan',
                            0.6: 'lime',
                            0.8: 'yellow',
                            1.0: 'red'
                        }
                    }).addTo(this.map);
                }
            }

            // Filter methods
            applyFilters() {
                this.filters.dateFrom = document.getElementById('dateFrom').value;
                this.filters.dateTo = document.getElementById('dateTo').value;
                this.filters.canisterCount = document.getElementById('filterCount').value;
                this.filters.condition = document.getElementById('filterCondition').value;

                this.filteredSightings = this.sightings.filter(sighting => {
                    // Date filter
                    if (this.filters.dateFrom) {
                        const fromDate = new Date(this.filters.dateFrom);
                        const sightingDate = new Date(sighting.timestamp);
                        if (sightingDate < fromDate) return false;
                    }
                    
                    if (this.filters.dateTo) {
                        const toDate = new Date(this.filters.dateTo);
                        toDate.setHours(23, 59, 59, 999); // End of day
                        const sightingDate = new Date(sighting.timestamp);
                        if (sightingDate > toDate) return false;
                    }

                    // Canister count filter
                    if (this.filters.canisterCount && sighting.canisterCount !== this.filters.canisterCount) {
                        return false;
                    }

                    // Condition filter
                    if (this.filters.condition && sighting.condition !== this.filters.condition) {
                        return false;
                    }

                    return true;
                });

                this.updateFilteredVisualization();
                this.updateStats();
                this.updateCharts();
            }

            clearFilters() {
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('filterCount').value = '';
                document.getElementById('filterCondition').value = '';
                
                this.filters = {
                    dateFrom: null,
                    dateTo: null,
                    canisterCount: '',
                    condition: ''
                };

                this.filteredSightings = [...this.sightings];
                this.updateFilteredVisualization();
                this.updateStats();
                this.updateCharts();
            }

            updateFilteredVisualization() {
                this.clearMapLayers();
                
                // Remove all existing markers
                this.markers.forEach(marker => {
                    if (marker._map) {
                        this.map.removeLayer(marker);
                    }
                });
                
                // Clear markers array and rebuild with filtered data
                this.markers = [];
                this.filteredSightings.forEach(sighting => {
                    this.addMarkerForFiltered(sighting);
                });
                
                this.updateMapVisualization();
            }

            addMarkerForFiltered(sighting) {
                const intensity = this.getSightingIntensity(sighting.lat, sighting.lng);
                let iconColor = 'green';
                
                if (intensity >= 6) iconColor = 'red';
                else if (intensity >= 3) iconColor = 'orange';

                const marker = L.marker([sighting.lat, sighting.lng], {
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                });

                const popupContent = `
                    <div style="min-width: 200px;">
                        <h4>🎈 Nitrous Oxide Sighting</h4>
                        <p><strong>Canisters:</strong> ${sighting.canisterCount}</p>
                        <p><strong>Condition:</strong> ${sighting.condition}</p>
                        <p><strong>Date:</strong> ${sighting.date}</p>
                        ${sighting.notes ? `<p><strong>Notes:</strong> ${sighting.notes}</p>` : ''}
                        ${sighting.photo ? `<img src="${sighting.photo}" style="width: 100%; max-width: 200px; height: auto; margin-top: 10px; border-radius: 4px;">` : ''}
                        <p style="font-size: 0.8em; color: #666; margin-top: 10px;">Intensity: ${intensity} sighting(s) in this area</p>
                    </div>
                `;

                marker.bindPopup(popupContent);
                this.markers.push(marker);
            }

            // Chart methods
            initCharts() {
                this.initTimeChart();
                this.initConditionChart();
                this.updateCharts();
            }

            initTimeChart() {
                const ctx = document.getElementById('timeChart').getContext('2d');
                this.charts.timeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Daily Sightings',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            initConditionChart() {
                const ctx = document.getElementById('conditionChart').getContext('2d');
                this.charts.conditionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Scattered', 'Dumped', 'Near Bins', 'Near Vehicle'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                '#ff6384',
                                '#36a2eb',
                                '#ffce56',
                                '#4bc0c0'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateCharts() {
                this.updateTimeChart();
                this.updateConditionChart();
                this.updateAnalytics();
            }

            updateTimeChart() {
                // Group sightings by date
                const dataToUse = this.filteredSightings.length > 0 ? this.filteredSightings : this.sightings;
                const dailyCounts = {};
                
                dataToUse.forEach(sighting => {
                    const date = sighting.date;
                    dailyCounts[date] = (dailyCounts[date] || 0) + 1;
                });

                // Sort dates and get last 14 days
                const sortedDates = Object.keys(dailyCounts).sort((a, b) => new Date(a) - new Date(b));
                const last14Days = sortedDates.slice(-14);
                
                const labels = last14Days.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                
                const data = last14Days.map(date => dailyCounts[date] || 0);

                this.charts.timeChart.data.labels = labels;
                this.charts.timeChart.data.datasets[0].data = data;
                this.charts.timeChart.update();
            }

            updateConditionChart() {
                const dataToUse = this.filteredSightings.length > 0 ? this.filteredSightings : this.sightings;
                const conditionCounts = {
                    'scattered': 0,
                    'dumped': 0,
                    'binned': 0,
                    'vehicle': 0
                };

                dataToUse.forEach(sighting => {
                    conditionCounts[sighting.condition] = (conditionCounts[sighting.condition] || 0) + 1;
                });

                this.charts.conditionChart.data.datasets[0].data = [
                    conditionCounts.scattered,
                    conditionCounts.dumped,
                    conditionCounts.binned,
                    conditionCounts.vehicle
                ];
                this.charts.conditionChart.update();
            }

            updateAnalytics() {
                const dataToUse = this.filteredSightings.length > 0 ? this.filteredSightings : this.sightings;
                
                // Calculate average canisters
                let totalCanisters = 0;
                dataToUse.forEach(sighting => {
                    switch(sighting.canisterCount) {
                        case '1-5': totalCanisters += 3; break;
                        case '6-10': totalCanisters += 8; break;
                        case '11-20': totalCanisters += 15; break;
                        case '20+': totalCanisters += 25; break;
                    }
                });
                const avgCanisters = dataToUse.length > 0 ? Math.round(totalCanisters / dataToUse.length) : 0;

                // Count hotspots (areas with 3+ sightings)
                const hotspots = this.getHotspotCount(dataToUse);

                document.getElementById('avgCanisters').textContent = avgCanisters;
                document.getElementById('hotspotCount').textContent = hotspots;
            }

            getHotspotCount(sightings) {
                const areas = {};
                const radius = 0.01; // roughly 1km
                
                sightings.forEach(sighting => {
                    const gridKey = `${Math.floor(sighting.lat / radius)}_${Math.floor(sighting.lng / radius)}`;
                    areas[gridKey] = (areas[gridKey] || 0) + 1;
                });

                return Object.values(areas).filter(count => count >= 3).length;
            }

            getSightingIntensity(lat, lng) {
                const radius = 0.01; // roughly 1km
                return this.sightings.filter(s => 
                    Math.abs(s.lat - lat) < radius && Math.abs(s.lng - lng) < radius
                ).length;
            }

            updateStats() {
                const today = new Date().toLocaleDateString();
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

                const todayCount = this.sightings.filter(s => s.date === today).length;
                const weekCount = this.sightings.filter(s => new Date(s.timestamp) >= weekAgo).length;

                document.getElementById('totalSightings').textContent = this.sightings.length;
                document.getElementById('todaySightings').textContent = todayCount;
                document.getElementById('weekSightings').textContent = weekCount;
                document.getElementById('filteredSightings').textContent = this.filteredSightings.length;
            }

            updateRecentSightings() {
                const recentList = document.getElementById('recentSightingsList');
                const recent = this.sightings.slice(-5).reverse();

                if (recent.length === 0) {
                    recentList.innerHTML = '<p style="color: #6c757d; font-style: italic;">No sightings yet. Click on the map to add one!</p>';
                    return;
                }

                recentList.innerHTML = recent.map(sighting => `
                    <div class="sighting-item">
                        <div class="sighting-location">${sighting.canisterCount} canisters</div>
                        <div class="sighting-details">${sighting.condition} • ${sighting.location.substring(0, 30)}...</div>
                        <div class="sighting-time">${new Date(sighting.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            }

            resetForm() {
                document.getElementById('sightingForm').reset();
                document.getElementById('location').value = '';
                document.getElementById('photoPreview').style.display = 'none';
                
                if (this.tempMarker) {
                    this.map.removeLayer(this.tempMarker);
                    this.tempMarker = null;
                }
                
                this.selectedLatLng = null;
            }

            saveSightings() {
                try {
                    localStorage.setItem('nitrousSightings', JSON.stringify(this.sightings));
                } catch (e) {
                    console.log('Could not save to localStorage, using memory storage only');
                }
            }

            generateTestData() {
                console.log('Generating fresh test data...');
                
                // Clear existing data
                this.sightings = [];
                this.filteredSightings = [];
                this.clearMapLayers();
                this.markers = [];
                
                // Clear localStorage
                try {
                    localStorage.removeItem('nitrousSightings');
                } catch (e) {
                    console.log('Could not clear localStorage');
                }

                const testData = [];
                const conditions = ['scattered', 'dumped', 'binned', 'vehicle'];
                const counts = ['1-5', '6-10', '11-20', '20+'];
                
                // Define London hotspot areas with varying intensities
                const hotspots = [
                    // Tower Hamlets - Major hotspot (120 sightings)
                    {
                        name: 'Tower Hamlets',
                        center: [51.5067, -0.0382],
                        radius: 0.008,
                        intensity: 120,
                        countBias: [0.2, 0.3, 0.3, 0.2] // Higher canister counts
                    },
                    // Camden - High activity (80 sightings)
                    {
                        name: 'Camden',
                        center: [51.5290, -0.1255],
                        radius: 0.006,
                        intensity: 80,
                        countBias: [0.3, 0.4, 0.2, 0.1]
                    },
                    // Hackney - High activity (75 sightings)
                    {
                        name: 'Hackney',
                        center: [51.5450, -0.0553],
                        radius: 0.007,
                        intensity: 75,
                        countBias: [0.25, 0.35, 0.25, 0.15]
                    },
                    // Southwark - Moderate activity (60 sightings)
                    {
                        name: 'Southwark',
                        center: [51.5016, -0.0877],
                        radius: 0.005,
                        intensity: 60,
                        countBias: [0.4, 0.3, 0.2, 0.1]
                    },
                    // Lambeth - Moderate activity (55 sightings)
                    {
                        name: 'Lambeth',
                        center: [51.4607, -0.1163],
                        radius: 0.006,
                        intensity: 55,
                        countBias: [0.35, 0.35, 0.2, 0.1]
                    },
                    // Westminster - Tourist area (45 sightings)
                    {
                        name: 'Westminster',
                        center: [51.4994, -0.1244],
                        radius: 0.004,
                        intensity: 45,
                        countBias: [0.5, 0.3, 0.15, 0.05]
                    },
                    // Islington - Moderate activity (50 sightings)
                    {
                        name: 'Islington',
                        center: [51.5362, -0.1034],
                        radius: 0.005,
                        intensity: 50,
                        countBias: [0.4, 0.35, 0.2, 0.05]
                    },
                    // Newham - East London (40 sightings)
                    {
                        name: 'Newham',
                        center: [51.5077, 0.0469],
                        radius: 0.008,
                        intensity: 40,
                        countBias: [0.45, 0.3, 0.2, 0.05]
                    },
                    // Greenwich - South East (35 sightings)
                    {
                        name: 'Greenwich',
                        center: [51.4769, 0.0005],
                        radius: 0.006,
                        intensity: 35,
                        countBias: [0.5, 0.3, 0.15, 0.05]
                    },
                    // Wandsworth - South West (30 sightings)
                    {
                        name: 'Wandsworth',
                        center: [51.4571, -0.1956],
                        radius: 0.007,
                        intensity: 30,
                        countBias: [0.6, 0.25, 0.1, 0.05]
                    }
                ];

                // Generate data for each hotspot
                let idCounter = 1000;
                hotspots.forEach(hotspot => {
                    for (let i = 0; i < hotspot.intensity; i++) {
                        // Generate random point within hotspot radius
                        const angle = Math.random() * 2 * Math.PI;
                        const distance = Math.random() * hotspot.radius;
                        const lat = hotspot.center[0] + distance * Math.cos(angle);
                        const lng = hotspot.center[1] + distance * Math.sin(angle);
                        
                        // Generate realistic timestamp with patterns
                        const daysAgo = this.generateRealisticDaysAgo();
                        const date = new Date();
                        date.setDate(date.getDate() - daysAgo);
                        
                        // Add time of day variation (more activity in evenings/weekends)
                        const hour = this.generateRealisticHour(date.getDay());
                        date.setHours(hour, Math.floor(Math.random() * 60));
                        
                        // Choose canister count based on hotspot bias
                        const canisterCount = this.weightedChoice(counts, hotspot.countBias);
                        
                        // Choose condition with area-specific bias
                        const condition = this.getConditionForArea(hotspot.name, conditions);
                        
                        testData.push({
                            id: idCounter++,
                            lat: lat,
                            lng: lng,
                            location: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                            canisterCount: canisterCount,
                            condition: condition,
                            notes: this.generateContextualNote(hotspot.name, condition, canisterCount),
                            photo: null,
                            timestamp: date.toISOString(),
                            date: date.toLocaleDateString()
                        });
                    }
                });

                // Add scattered sightings across other London areas (50 random sightings)
                const londonBounds = {
                    north: 51.6723,
                    south: 51.2867,
                    east: 0.3340,
                    west: -0.5103
                };

                for (let i = 0; i < 50; i++) {
                    const lat = londonBounds.south + Math.random() * (londonBounds.north - londonBounds.south);
                    const lng = londonBounds.west + Math.random() * (londonBounds.east - londonBounds.west);
                    
                    const daysAgo = Math.floor(Math.random() * 60); // Longer time range for scattered data
                    const date = new Date();
                    date.setDate(date.getDate() - daysAgo);
                    date.setHours(Math.floor(Math.random() * 24), Math.floor(Math.random() * 60));
                    
                    testData.push({
                        id: idCounter++,
                        lat: lat,
                        lng: lng,
                        location: `${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                        canisterCount: counts[Math.floor(Math.random() * counts.length)],
                        condition: conditions[Math.floor(Math.random() * conditions.length)],
                        notes: this.generateRandomNote(),
                        photo: null,
                        timestamp: date.toISOString(),
                        date: date.toLocaleDateString()
                    });
                }

                console.log(`Generated ${testData.length} mock sightings across London`);
                
                this.sightings = testData;
                this.filteredSightings = [...this.sightings];
                
                // Add all markers
                this.sightings.forEach(sighting => this.addMarker(sighting));
                
                // Update all UI components
                this.updateRecentSightings();
                this.updateMapVisualization();
                this.updateStats();
                this.updateCharts();
                
                // Save to localStorage
                this.saveSightings();
            }

            generateRealisticDaysAgo() {
                // More recent sightings are more likely
                const random = Math.random();
                if (random < 0.4) return Math.floor(Math.random() * 7); // 40% in last week
                if (random < 0.7) return 7 + Math.floor(Math.random() * 14); // 30% in 2-3 weeks
                return 21 + Math.floor(Math.random() * 30); // 30% in last month
            }

            generateRealisticHour(dayOfWeek) {
                // Weekend patterns (Friday=5, Saturday=6, Sunday=0)
                if (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0) {
                    // More activity in evenings and late night on weekends
                    const random = Math.random();
                    if (random < 0.3) return 14 + Math.floor(Math.random() * 6); // 2-8 PM
                    if (random < 0.6) return 20 + Math.floor(Math.random() * 4); // 8 PM - midnight
                    if (random < 0.8) return Math.floor(Math.random() * 4); // midnight - 4 AM
                    return Math.floor(Math.random() * 24); // any time
                } else {
                    // Weekday patterns - more evening activity
                    const random = Math.random();
                    if (random < 0.4) return 17 + Math.floor(Math.random() * 5); // 5-10 PM
                    if (random < 0.6) return 12 + Math.floor(Math.random() * 5); // noon-5 PM
                    return Math.floor(Math.random() * 24); // any time
                }
            }

            weightedChoice(choices, weights) {
                const random = Math.random();
                let sum = 0;
                for (let i = 0; i < weights.length; i++) {
                    sum += weights[i];
                    if (random <= sum) return choices[i];
                }
                return choices[choices.length - 1];
            }

            getConditionForArea(areaName, conditions) {
                // Different areas have different condition patterns
                const areaPatterns = {
                    'Tower Hamlets': [0.4, 0.3, 0.2, 0.1], // More scattered/dumped
                    'Camden': [0.3, 0.2, 0.3, 0.2], // Mixed, more near bins (tourist area)
                    'Westminster': [0.2, 0.1, 0.5, 0.2], // More near bins (central)
                    'Hackney': [0.45, 0.25, 0.2, 0.1], // More scattered
                    'Southwark': [0.35, 0.25, 0.25, 0.15],
                    'Lambeth': [0.4, 0.2, 0.25, 0.15],
                    'Islington': [0.35, 0.2, 0.3, 0.15],
                    'Newham': [0.4, 0.3, 0.2, 0.1],
                    'Greenwich': [0.3, 0.2, 0.3, 0.2],
                    'Wandsworth': [0.35, 0.15, 0.35, 0.15]
                };
                
                const weights = areaPatterns[areaName] || [0.25, 0.25, 0.25, 0.25];
                return this.weightedChoice(conditions, weights);
            }

            generateContextualNote(area, condition, count) {
                const areaSpecificNotes = {
                    'Tower Hamlets': [
                        "Found near Canary Wharf station area",
                        "Reported by local resident during morning walk",
                        "High concentration near shopping areas",
                        "Close to DLR station entrance"
                    ],
                    'Camden': [
                        "Tourist area, mixed with other litter",
                        "Near Camden Market, heavy foot traffic",
                        "Found along canal towpath",
                        "Close to music venues"
                    ],
                    'Westminster': [
                        "Central London, near government buildings",
                        "Tourist hotspot area",
                        "Found near bus stops and tube stations",
                        "Mixed with general street litter"
                    ],
                    'Hackney': [
                        "Residential area sighting",
                        "Near local parks and green spaces",
                        "Reported during community clean-up",
                        "Close to nightlife venues"
                    ]
                };

                const conditionNotes = {
                    'scattered': "Spread across wide area, individual canisters",
                    'dumped': "Large pile, appears to be deliberate dumping",
                    'binned': "Found near waste disposal area",
                    'vehicle': "Concentrated near parking area"
                };

                const countNotes = {
                    '1-5': "Small number of canisters",
                    '6-10': "Moderate amount found",
                    '11-20': "Significant quantity discovered",
                    '20+': "Large scale dumping, concerning amount"
                };

                const specificNotes = areaSpecificNotes[area] || this.generateRandomNote().split(',');
                const randomSpecific = specificNotes[Math.floor(Math.random() * specificNotes.length)];
                
                // 70% chance of having a note
                if (Math.random() < 0.7) {
                    const parts = [randomSpecific];
                    if (Math.random() < 0.3) parts.push(conditionNotes[condition]);
                    if (Math.random() < 0.2) parts.push(countNotes[count]);
                    return parts.join('. ');
                }
                
                return '';
            }

            generateRandomNote() {
                const notes = [
                    "Found near park entrance, scattered across path",
                    "Large pile dumped behind building",
                    "Mixed in with other litter near bus stop",
                    "Concentrated area by vehicle parking",
                    "Evidence of recent use, still cold to touch",
                    "Near school grounds, concerning location",
                    "Found early morning during clean-up walk",
                    "Reported by local resident",
                    "High concentration area, regular hotspot",
                    "New area, first sighting reported here"
                ];
                return Math.random() < 0.7 ? notes[Math.floor(Math.random() * notes.length)] : '';
            }

            loadSightings() {
                try {
                    const saved = localStorage.getItem('nitrousSightings');
                    if (saved) {
                        this.sightings = JSON.parse(saved);
                        this.filteredSightings = [...this.sightings];
                        this.sightings.forEach(sighting => this.addMarker(sighting));
                        this.updateRecentSightings();
                        this.updateMapVisualization();
                    }
                } catch (e) {
                    console.log('Could not load from localStorage, starting fresh');
                    this.sightings = [];
                    this.filteredSightings = [];
                }
            }
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new NitrousTracker();
        });
    </script>
</body>
</html>